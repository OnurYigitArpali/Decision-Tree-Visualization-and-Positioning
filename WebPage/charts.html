<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Grafikler</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.min.js"></script>
    <style>
        #overlay {
            position: fixed;
            display: block;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.2);
            z-index: 2;
            cursor: pointer;
        }
        #overlay_text{
            position: absolute;
            top: 50%;
            left: 62%;
            font-size: 30px;
            color: white;
            transform: translate(-50%,-50%);
            -ms-transform: translate(-50%,-50%);
        }
        #overlay_button{
            position: absolute;
            top: 80%;
            right: 30%;
        }
        .blur {
            -webkit-filter: blur(5px); /* Chrome, Safari, Opera */
            filter: blur(5px);
        }
    </style>

    <script>
        var features = {"Yaş": ["Genç", "Orta", "Yaşlı"], "Göz Bozukluğu" : ["Miyop", "Hipermetrop"], "Astigmat" : ["Yok", "Var"], "Göz yaşı üretimi" : ["Az", "Normal"]}
        var labelDict = {1 : "Sert Lens Kullananlar", 2: "Yumuşak Lens Kullananlar", 3: "Lens Kullanamayanlar"}
        function readTextFileAndPlot(file)
        {
            var rawFile = new XMLHttpRequest();
            rawFile.open("GET", file, false);
            rawFile.onreadystatechange = function ()
            {
                if(rawFile.readyState === 4)
                {
                    if(rawFile.status === 200 || rawFile.status == 0)
                    {
                        var allText = rawFile.responseText;
                        var df = []
                        var tokenized = allText.split("\n")
                        for(var i = 0; i < tokenized.length; i++){
                            var tokens = tokenized[i].split("  ")
                            df.push(tokens)
                        }
                        var chartAreaDiv = document.getElementById("chartArea");
                        var textDiv = document.createElement("div")
                            textDiv.classList.add("col-sm-1")
                            textDiv.style.marginTop = "3%"
                        chartAreaDiv.appendChild(textDiv)

                        for(var i = 0; i < Object.keys(features).length; i++){
                            var canvas = document.createElement('canvas');
                            canvas.id = "myChart" + i;
                            canvas.classList.add("col-sm-2")
                            canvas.style.width = "600px"
                            if(i != Object.keys(features).length - 1) {
                                    canvas.style.borderLeft = "1px solid black"
                            }else{
                                canvas.style.borderLeft = "1px solid black"
                                canvas.style.borderRight = "1px solid black"
                            }
                            canvas.style.height = "175px"
                            chartAreaDiv.appendChild(canvas)
                            var key = Object.keys(features)[i]
                            drawGraph(Object.values(calculateFrequence(df, i)), features[key], key, "myChart" + i)
                        }
                        var hr = document.createElement("hr")
                        hr.style.backgroundColor = "black";
                        document.body.appendChild(hr)
                        for(var i = 0; i < Object.keys(labelDict).length; i++){
                            var div = document.createElement("div")
                            div.classList.add("row")
                            div.style.marginRight = "0px"
                            div.style.marginLeft = "0px"
                            var tempArray = []
                            for( var k = 0; k < df.length; k++){
                                if(Number(df[k][4]) == i + 1){
                                    tempArray.push(df[k])
                                }
                            }
                            document.body.appendChild(div)

                            var textDiv = document.createElement("div")
                            textDiv.classList.add("col-sm-1")
                            textDiv.innerHTML = labelDict[i + 1]
                            textDiv.style.marginTop = "3%"
                            div.appendChild(textDiv)
                            for(var j = 0; j < Object.keys(features).length; j++){
                                var canvas = document.createElement('canvas');
                                canvas.id = "myLabelChart" + i + "" + j;
                                canvas.classList.add("col-sm-2")
                                div.appendChild(canvas)
                                canvas.style.width = "600px"
                                canvas.style.height = "175px"
                                if(j != Object.keys(features).length - 1) {
                                    canvas.style.borderLeft = "1px solid black"
                                }else{
                                    canvas.style.borderLeft = "1px solid black"
                                    canvas.style.borderRight = "1px solid black"
                                }
                                var key = Object.keys(features)[j]
                                drawGraph(Object.values(calculateFrequence(tempArray, j)), features[key], key, "myLabelChart" + i + "" + j)
                            }
                        }
                    }
                }
                afterGraphCompleted()
            }
            rawFile.send(null);

        }
        /**
        1. age of the patient: (1) young, (2) pre-presbyopic, (3) presbyopic
        2. spectacle prescription:  (1) myope, (2) hypermetrope
        3. astigmatic:     (1) no, (2) yes
        4. tear production rate:  (1) reduced, (2) normal
         */
        function calculateFrequence(data, colNumber){
            freqDict = {}
            var key = Object.keys(features)[colNumber]
            for (var j = 0; j < features[key].length; j++) {
                freqDict[j + 1] = 0
            }
            for(var i = 0; i < data.length; i++){
                if(Number(data[i][colNumber]) in freqDict){
                    freqDict[Number(data[i][colNumber])]++;
                } else {
                    freqDict[Number(data[i][colNumber])] = 1;
                }
            }
            return freqDict;
        }
        function drawGraph(data, labels, label, chartID){
            var datalist = {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            'rgb(252, 200, 42)',
                            'rgb(160, 190, 239)',
                            'rgb(77, 193, 73)',
                            'rgba(75, 192, 192, 0.2)',
                            'rgba(255, 159, 64, 0.2)'
                        ],
                        borderColor: [
                            'rgb(252, 200, 42)',
                            'rgb(160, 190, 239)',
                            'rgb(77, 193, 73)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 1
                    }]
                }
            var ctx = document.getElementById(chartID).getContext('2d');
            var myChart = new Chart(ctx, {
                type: 'bar',
                data: datalist,
                options: {
                    scales: {
                        yAxes: [{
                            ticks: {
                                max: 12,
                                beginAtZero:true
                            },
                            scaleLabel: {
                                display: true,
                                labelString: 'Kişi Sayısı'
                            }
                        }]
                    },
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: label
                    }
                }
            });
        }
        $( function() {
            readTextFileAndPlot("lens.txt")
        });
        function afterGraphCompleted(){
            console.log("finished")
            $("#header0, #myChart0, #myLabelChart00, #myLabelChart10, #myLabelChart20").addClass("blur")
            $("#header1, #myChart1, #myLabelChart01, #myLabelChart11, #myLabelChart21").addClass("blur")
            $("#header3, #myChart3, #myLabelChart03, #myLabelChart13, #myLabelChart23").addClass("blur")
        }
    </script>
</head>
<body>
    <div class="row" style="margin-left: 0px">
        <div id = "header0" class = "col-sm-2" style="margin-left: 15%">Yaş</div>
        <div id = "header1" class = "col-sm-2">Göz Bozukluğu</div>
        <div id = "header2" class = "col-sm-2">Astigmat</div>
        <div id = "header3" class = "col-sm-2">Göz yaşı üretimi</div>`
    </div>
    <div id = "chartArea" class = "row" style="margin-left: 0px; margin-right: 0px">
    </div>

</body>
</html>