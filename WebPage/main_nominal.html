<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>İnteraktif Karar Ağacı</title>
  <style>
    @font-face {
        font-family: "San Fransisco";
        src: url(sf.otf) format("truetype");
    }
    ul{
        list-style-type: none;
    }
    td{
        vertical-align: top;
    }
    #main_list{
        margin-top: 5px;
    }
    #sorular{
        width: 200px;
        color: white;
        background-color: #3564f2;
        padding-bottom: 5px;
        margin-top: 4px;
        height: 55px;
        font-size: 18px;
    }
    #main_list tbody tr{
        background-color: rgba(221,221,221,0.54);
        text-align: left;
        border: 1px solid black;
        width: 750px;
        padding: 2px 2px 2px 2px;
        margin-top: 5px;
    }

    #left, #right{
        min-width: 450px;
        margin: 25px;
        padding: 0px 0px 0px 0px
    }
    #left tbody tr, #right tbody tr{
        word-break: break-all;
        background-color: lightgreen;
        border: 1px solid black;
        width: 750px;
        margin: 5px;
    }
    .blur {
        -webkit-filter: blur(5px); /* Chrome, Safari, Opera */
        filter: blur(5px);
    }
    .row{
        margin: 0px 0px 0px 0px;
    }
    #overlay {
        position: fixed;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0,0,0,0.4);
        z-index: 2;
        cursor: pointer;
    }
    #overlay_text{
        position: fixed;
        top: 50%;
        left: 77%;
        z-index: 1000;
        font-size: 30px;
        color: white;
        width: 40%;
        transform: translate(-50%,-50%);
        -ms-transform: translate(-50%,-50%);
    }
    #overlay_button{
        position: fixed;
        top: 80%;
        right: 30%;
        z-index: 1000;
    }
  </style>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.min.js"></script>
  <script>
  var startingIndexOfLeftRight = 0;
  var isTutorial = true;
  //var data = [["Yeşil", "Tatlı", "Karpuz"],['Yeşil', "Ekşi", 'Elma'], ['Kırmızı', "Tatlı", 'Elma'], ['Sarı', "Ekşi", 'Limon']]

  var data = [
                  ["Trion Lannister", "Zengin değil", "Yok", "İstemiyor", "Sarı", "Lannister"],
                  ["Daenerys Targaryen", "Zengin", "Var", "İstiyor", "Beyaz", "Targaryen"],
                  ["John Snow", "Zengin değil", "Yok", "İstemiyor", "Siyah", "Basterd"],
                  ["Cercei Lannister", "Zengin", "Yok", "İstiyor", "Sarı", "Lannister"],
                  ["Night King", "Zengin değil", "Var", "İstemiyor", "Beyaz", "White Walker"],
                  ["Jamie Lannister", "Zengin", "Yok", "İstemiyor",  "Sarı", "Lannister"],
                  ["Arya Stark", "Zengin değil", "Yok", "İstemiyor", "Siyah", "Stark"],
                  ["Tywin Lannister", "Zengin", "Yok", "İstiyor",  "Sarı", "Lannister"],
                  ["Sansa Stark", "Zengin değil", "Yok", "İstemiyor", "Kızıl", "Stark"],
                  ["Lieutenant White Walkers", "Zengin değil", "Var", "İstemiyor", "Beyaz", "White Walker"],
                  ["Viserys Targaryen", "Zengin değil", "Yok",  "İstiyor", "Beyaz", "Targaryen"],
                  ["Wights", "Zengin değil", "Yok", "İstemiyor", "Beyaz", "White Walker"],
                  ["Eddard Stark", "Zengin değil", "Yok", "İstemiyor", "Siyah", "Stark"],
                ]



  var dict = {}
  var questions = {"Kırmızı mı?" : {attribute :"Kırmızı", type: 0},
          "Sarı mı?": {attribute: "Sarı", type: 0},
          "Ekşi mi?": {attribute: "Ekşi", type: 1},
          "Zengin mi?": {attribute: "Zengin", type: 1},
          "Beyaz saçlı mı?": {attribute: "Beyaz", type: 4},
          "Ejderyası var mı?": {attribute: "Var", type: 2}};
  var labelToImage = {"Karpuz" : "watermelon.png", "Elma" : {"Kırmızı" : "apple.png", "Yeşil": "green_apple.png"}, "Limon": "lemon.png"}
  var descriptions = ["Burada bir marketteki meyve reyonunda bulunan ürünlerin listesi bulunmakta",
                      "Belirtilen kısımdaki sorulara tıklayarak verilerinizi ikiye ayırabilirsiniz",
                      "Veriler sorduğunuz soruya göre ikiye ayrıldı",
                      "Bu entropi değeri 'Evet' kısmındaki verilerin karmaşıklığını ifade eder",
                      "Bu entropi değeri ise 'Hayır' kısmındaki verilerin karmaşıklığını ifade eder",
                      "Verilerinizdeki tamamındaki karmaşıklık oranı burada gösterilmektedir",
                      "Bu soruyu sormakla elde edeceğiniz karmaşıklığı azalma miktarı 'sorunun skoru' olarak belirtilmektedir",
                      "Şimdi de verilerinize uygun bir soru sorun ve onları sürükleyip 'Evet' veya 'Hayır' alanlarına bırakın",
                      "Verilerinizi bu şekilde yukarıda eleman kalmayana kadar bölün ve en son sorunun skorunu hesaplamak için Hesapla butonuna tıklayınız. Resetle butonu ile verileri geri yukarı taşıyabilirsiniz"]
  function calculateEntropy(data){
      totalNumber = data.length
      labelDict = {}
      for (var i in data){
        //get the last column which is the label
          entry = data[i]
        decision = entry[entry.length - 1]
        if( decision in labelDict){
            labelDict[decision]++;
        } else {
            labelDict[decision] = 1.0
        }
      }
      entropy = 0.0
      for(var key in labelDict){
          prob = labelDict[key] / totalNumber
          entropy -= prob * Math.log2(prob);
      }
      return entropy
  }
  $( function() {
    //tutorial section
    var descIndex = 0;
    $(".a0 .a1").css("z-index", 999)
    $("#overlay_text").html(descriptions[descIndex])
    descIndex++;
    $("#overlay_button").click(()=>{
        $("#overlay_text").html(descriptions[descIndex])
        console.log(descIndex)
        if(descIndex == 1){
            $(".a0 .a1").css("z-index", 0)
            $(".a0 .a2").css("z-index", 999)
            $("#overlay_button").css("display", "none")
        } else if(descIndex == 3) { // == 2 is handled by question buttons
            $(".c0 .c1").css("z-index", 0)
            $(".d0 .d1").css("z-index", 999)
        } else if(descIndex == 4){
            $(".d0 .d1").css("z-index", 0)
            $(".d0 .d2").css("z-index", 999)
        } else if (descIndex == 5){
            $(".d0 .d2").css("z-index", 0)
            $(".f0").css("z-index", 999)
        } else if (descIndex == 6){
            $(".f0").css("z-index", 0)
            $(".g0 .g1").css("z-index", 999)
        } else if(descIndex == 7){
            $(".g0 .g1").css("z-index", 0)
            $(".overlay").css("display", "none")
            isTutorial = false;
        } else if(descIndex == descriptions.length - 1){
            $(".b0 .b1").css("z-index", 0)
            $(".overlay").css("display", "none")
            isTutorial = false;
        }
        descIndex++;
    })
    for (var question in questions){
        var button = document.createElement("button")
        var $button = $(button);
        $button.attr("id", i).css("margin-top", "10px").css("width", "200px").addClass("btn").addClass("btn-primary").addClass("btn-lg").html(question).appendTo("#question_list")
        $button.click((function(question) {return function() {
            resetLeftRight()
            resetEntropyValues()
            var mainItems = $("#main_list tbody tr");
            console.log(question)
            for(var i = 0; i < mainItems.length; i++){
                var $item = $(mainItems[i]);
                var conditionAttribute = dict[$item.attr("id")]["attributeValues"][question["type"]];
                if(conditionAttribute == question["attribute"]){
                    $("#left").append($("#" + $item.attr("id")));
                }else{
                    $("#right").append($("#" + $item.attr("id")));
                }
            }
            var totalNumber = mainData.length//left
            leftEntropy = calculateEntropyById("#left tbody tr") //excludes first item haaaaaaaaaaaaaa
            leftSize = $("#left tbody tr").length - 1
            //right
            rightEntropy = calculateEntropyById("#right tbody tr")//excludes first item haaaaaaaaaaaaaa
            rightSize = $("#right tbody tr").length - 1
            var averageEntropy = (leftSize / totalNumber) * leftEntropy + (rightSize / totalNumber) * rightEntropy
            $("#averageEntropy").html("Ortalama Entropi: " + averageEntropy.toFixed(2))
            var gain = mainEntropy - averageEntropy
            $("#totalGain").html("Bu sorunun skoru: " + gain.toFixed(2))
            recalculateLeftRight()
            if(isTutorial){
                $(".a0 .a2").css("z-index", 0)
                $(".c0 .c1").css("z-index", 999)
                $("#overlay_text").html(descriptions[descIndex])
                $("#overlay_button").css("display", "block")
                descIndex++;
            }
        };})(questions[question]));
    }
    //Generilize the data and create a dict
    data.forEach((entry, i) => {
        var obje = { attributeValues : entry}
        var text = ""
        var $table = $("#main_list")
        var $tr = $("<tr>")
        var previous = null
        for(var attribute in entry) {
            text += entry[attribute] + "  "
            $tr.append("<td>" + entry[attribute] + "</td>")
        }
        /*
        var cellImg = tr.insertCell()
        var entryLabel = entry[entry.length - 1]
        if(entryLabel != "Elma") {
            cellImg.innerHTML = "<img src = 'icons/" + labelToImage[entryLabel] + "' width = '30'></img>"
        } else {
            cellImg.innerHTML = "<img src = 'icons/" + labelToImage[entryLabel][entry[0]] + "' width = '30'></img>"
        }
        */
        var $newNode = $tr.attr("id", "entry_" + i)
        dict[$newNode.attr("id")] = obje
        $("#main_list > tbody").append($newNode);
    });
    //General calculateEntropyById, excludes first item haaaaaaaaaaaaaa
    function calculateEntropyById(id){
        var leftData = []
        var leftItems = $(id)
        for(var i = startingIndexOfLeftRight; i < leftItems.length; i++){
            var $item = $(leftItems[i])
            tokens = dict[$item.attr("id")]["attributeValues"]
            console.log(tokens)
            leftData.push(tokens)
        }
        return calculateEntropy(leftData)
    }
    //reset left and right div to mainlist
    function resetLeftRight(){
        var leftItems = $("#left tbody tr");
        for(var i = startingIndexOfLeftRight; i < leftItems.length; i++){
           var $item = $(leftItems[i]);
           $("#main_list tbody").append($("#" + $item.attr("id")))
        }
        var rightItems = $("#right tbody tr")
        for(var i = startingIndexOfLeftRight; i < rightItems.length; i++){
           var $item = $(rightItems[i]);
           $("#main_list tbody").append($("#" + $item.attr("id")))
        }
    }
    function resetEntropyValues(){
        $("#leftEntropy, #rightEntropy").html("Entropi: -");
        $("#averageEntropy").html("Ortalama Entropi: -")
        $("#totalGain").html("Bu sorunun skoru: -")
    }
    //recalculates entropy of the left and right divs
    function recalculateLeftRight(){
        //left
        leftEntropy = calculateEntropyById("#left tbody tr") //excludes first item haaaaaaaaaaaaaa
        //right
        rightEntropy = calculateEntropyById("#right tbody tr")//excludes first item haaaaaaaaaaaaaa
        $("#leftEntropy").html("Entropi: " + leftEntropy.toFixed(2))
        $("#rightEntropy").html("Entropi: " + rightEntropy.toFixed(2))
        console.log("Left: ", leftEntropy, "Right: ", rightEntropy)
    }
    //Calculate main entropy
    mainData = []
    var mainItems = $("#main_list li")
    for(var i = 1; i < mainItems.length; i++){
        var $item = $(mainItems[i])
        console.log($item.attr("id"))
        tokens = dict[$item.attr("id")]["attributeValues"]
        mainData.push(tokens)
    }
    mainEntropy = calculateEntropy(mainData)
    $("#mainEntropy").html("Sistemin Entropisi: " + mainEntropy.toFixed(2))
      //Define method when sorting completed
    function onStopSorting(event, ui){
        if(isTutorial){
            $("#overlay_text").html(descriptions[descIndex])
            $(".a0 .a1").css("z-index", 0)
            $(".c0 .c1").css("z-index", 0)
            $(".b0 .b1").css("z-index", 999)
            $("#overlay_button").css("display", "block")
        }
        var item = ui.item
        resetEntropyValues()
        var $main_list = $("#main_list")
        console.log($main_list)
        if($main_list[0].childElementCount == 1){
            recalculateLeftRight()
        }
    }
    $('#left, #right').sortable({
        stop: onStopSorting,
        items: "#left tbody tr, #right tbody tr"
    });
    $("#main_list, #left, #rigth").disableSelection();
    $("#calculate").click(()=>{
        if ($("#main_list")[0].childElementCount == 1) {
            var leftList = $("#left tbody tr")
            featuresMatrix = []
            for(var i = 1; i < leftList.length; i++){
                var $item = $(leftList[i])
                attributeArr = dict[$item.attr("id")]["attributeValues"]
                featuresMatrix.push([])
                for(var j = 0; j < attributeArr.length; j++){
                    featuresMatrix[i - 1].push(attributeArr[j])
                }
            }
            console.log(featuresMatrix)
            validSplit = false;
            for(var col = 0; featuresMatrix != [] && col < featuresMatrix[0].length - 1 && !validSplit; col++){
                var previous = featuresMatrix[0][col] // first element is previous
                var differentFound = false;
                for(var row = 1; !differentFound && row < featuresMatrix.length; row++){
                    if(featuresMatrix[row][col] != previous){
                        differentFound = true;
                    }
                }
                if(!differentFound){
                    validSplit = true
                }
            }
            console.log(validSplit)

            if(validSplit) {
                var totalNumber = mainData.length//left
                leftEntropy = calculateEntropyById("#left tbody tr") //excludes first item haaaaaaaaaaaaaa
                leftSize = $("#left tbody tr").length - 1
                //right
                rightEntropy = calculateEntropyById("#right tbody tr")//excludes first item haaaaaaaaaaaaaa
                rightSize = $("#right tbody tr").length - 1
                var averageEntropy = (leftSize / totalNumber) * leftEntropy + (rightSize / totalNumber) * rightEntropy
                $("#averageEntropy").html("Ortalama Entropi: " + averageEntropy.toFixed(2))
                var gain = mainEntropy - averageEntropy
                $("#totalGain").html("Bu sorunun skoru: " + gain.toFixed(2))
            }  else {
                $("#error").html("Verilerinizi herhangi bir soruya veya ortak özelliğe göre bölmediniz.")
                $("#error").slideDown().delay(5000).slideUp()
            }
        } else {
            $("#error").html("Bütün elemanlar paylaştırılmadan sorunun skoru hesaplanamaz")
            $("#error").slideDown().delay(5000).slideUp()
        }
    });
    $("#reset").click(()=>{
        resetLeftRight()
        resetEntropyValues()
    })
    var i = 0;
    var guide = {"a0": ["a1", "a2"], "b0": ["b1", "b2"], "c0": ["c1"], "d0" : ["d1","d2"], "e0": ["e1"], "f0": ["f1"]}
    var keys = Object.keys(guide)
    var i = 0;
    var j = 0;
    var previousI = -1;
    var previousJ = -1;
    $("#next").click(()=>{
        if(previousI != -1) {
            $("body div:not(." + keys[previousI] + ")").removeClass("blur")
            $("." + guide[keys[previousI]][previousJ]).tooltip("hide")
        }
        $("div:not(." + keys[i] + ")").addClass("blur")
        $("body ." + keys[i] + " ." + guide[keys[i]][j] ).removeClass("blur")
        $("." + guide[keys[i]][j]).tooltip("show")
        previousI = i;
        previousJ = j;
        if(j + 1 == guide[keys[i]].length){
            i++;
            j = 0;
        }else {
            j++;
        }
    })
    $("#proceed").click(()=>{
        resetLeftRight()
        resetEntropyValues()
        startingIndexOfLeftRight = 0
        $("#proceed").css("display", "none")
        $("#question_list").css("display", "none")
        $("#reset").css("display", "inline-block")
        $("#calculate").css("display", "inline-block")
        $("#left thead tr, #right thead tr").append("<th>Buraya sürükleyiniz</th>")
        //$("#left li:first-child, #right li:first-child").css("background-color", "orange")
        $('#right tbody tr, #left tbody tr, #main_list tbody tr').draggable({
            connectToSortable: ".sortable",
            revert: 'invalid',
            drag: function( event, ui ) {
                $(ui.helper).css("position", "absolute")
                console.log(ui.helper)
            },
            stop: function( event, ui ) {
                $(ui.helper).css("position", "")
                console.log(ui.helper)
            }
        });
        //Tutorial part
        $(".overlay").css("display", "block")
        $(".a0 .a1").css("z-index", 999)
        $(".c0 .c1").css("z-index", 999)
        $("#overlay_button").css("display", "none")
        isTutorial = true
    })
  });
  </script>
</head>
<body>
<div id ="error" class="alert alert-warning" style="z-index: 999; display: none; position: fixed; z-index: 999; width: 50%; margin-left: 25%; text-align: center" role="alert">
</div>
<button id = "next" type="button" style="margin-bottom: 15px; display:none" class="btn btn-outline-primary">İlerle</button>
<div class = "row a0" align="center" style="margin-left: 5%; margin-right: 0px">
    <div class ="a1 col-sm-6" >
        <table id = "main_list">
            <thead>
                <tr id = "header" style="background-color: red;">
                    <th>Adı</th>
                    <th>Zengin mi?</th>
                    <th>Ejderhası var mı?</th>
                    <th>Tahtı istiyor mu?</th>
                    <th>Saç rengi</th>
                    <th>Ailesi</th>
                </tr>
            </thead>
            <tbody>

            </tbody>
        </table>
    </div>
    <div class = "a2 col-sm-2">
        <ul id = "question_list">
        </ul>
    </div>
</div>
<div class = "b0 row" align="center" style="margin-left: 4.5%; margin-right: 0px">
    <div class = "b1 col-sm-12">
        <button id = "proceed" type="button" style="margin-bottom: 15px" class="btn btn-outline-success">Kendi Sorunu Belirle</button>
        <button id = "reset" type="button" style="display: none; margin-bottom: 15px" class="btn btn-outline-danger">Resetle</button>
        <button id = "calculate" type="button" style="display: none; margin-bottom: 15px" class="btn btn-outline-primary">Hesapla</button>
    </div>
</div>
<div class="c0 row" style="margin-right: 0px">
    <div class = "c1">
        <table class = "" border="3px" style = "min-height: 300px; margin-left: 30px" >
            <th style="text-align: center">Evet</th>
            <th style="text-align: center; padding-top: 0px">Hayir</th>
            <tr>
                <td>
                    <table id='left' class = "sortable">
                        <thead>
                            <tr>

                            </tr>
                        </thead>
                        <tbody>

                        </tbody>
                    </table>
                </td>
                <td>
                    <table id='right' class = "sortable">
                        <thead>
                            <tr>

                            </tr>
                        </thead>
                        <tbody>

                        </tbody>
                    </table>
                </td>
            </tr>
        </table>
    </div>
</div>
<div class="row d0" style="margin-right: 0px">
    <div id = "leftEntropy" style="background-color: red; color: white;margin-left: 8%" class="d1 col-sm-2" align="center" >
        Entropi: -
    </div>
    <div id = "rightEntropy" style="background-color: red; color: white;margin-left: 11%" class = "d2 col-sm-2" align="center">

        Entropi: -
    </div>
</div>
<br>
<div class="row e0" align="center" style="display: none; margin-right: 0px">
    <div id = "averageEntropy" class = "e1 col-sm-7">
    Ortalama Entropi: -
    </div>
</div>
<div  id = "mainEntropy" class = "f0 col-sm-2"  align = "center" style="margin-left: 21%; background-color: orange" >
        <span>Sistemin Entropisi: -</span>
</div>
<br>
<div class="row g0" align="center" style="margin-right: 0px">
    <div id = "totalGain" class = "g1 col-sm-2" style="margin-left: 21.7%; background-color: orange">
    Bu sorunun skoru: -
    </div>
</div>
<div id="overlay" class = "overlay">
</div>

<div id="overlay_text" class = "overlay"></div>
<button id="overlay_button" class="overlay btn btn-warning" >Anladım</button>
<br>
<div>Icons made by <a href="https://www.flaticon.com/authors/smashicons" title="Smashicons">Smashicons</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a> is licensed by <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0" target="_blank">CC 3.0 BY</a></div>
<div>Icons made by <a href="http://www.freepik.com" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a> is licensed by <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0" target="_blank">CC 3.0 BY</a></div>
</body>
</html>